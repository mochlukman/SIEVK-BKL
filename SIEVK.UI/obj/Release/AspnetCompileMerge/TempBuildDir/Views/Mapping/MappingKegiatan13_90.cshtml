@{
    ViewBag.Title = "Mapping - Kegiatan 13 (lama) ke Permen 90";
}

<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <script>
        var deleteStatus = true;
        var IDdelete = 0;

        var idPrgrm = '@ViewBag.idPrgrm';
        var idKeg = '@ViewBag.idKeg';
        var idKEG90 = '@ViewBag.idKEG90';

        $(document).ready(function () {        
            $('[data-toggle="tooltip"]').tooltip();
        
            $("#IDProgramSelected").val('@ViewBag.idprgrm')
            $("#NameProgramSelected").val('@ViewBag.programName')
            $("#program-flexdatalist").val('@ViewBag.programName')

            $("#IDKegiatanSelected").val('@ViewBag.idKeg')
            $("#NameKegiatanSelected").val('@ViewBag.kegiatanName')
            $("#kegiatan-flexdatalist").val('@ViewBag.kegiatanName')
        
            $("#list").DataTable({
                "processing": false, // for show progress bar
                "serverSide": true, // for process server side
                "filter": true, // this is for disable filter (search box)
                "orderMulti": false, // for disable multiple column at once
                "pageLength": 10,
                "scrollCollapse": true,
                "scrollX": true,
                "scrollY": "350px", //cukup untuk 10 row
                "ajax": {
                    "url": '@Url.Content("~/")' + "Mapping/LoadDataMappingKegiatan13_90",
                    "type": "POST",
                    "datatype": "json",
                    "data": {
                        "idKeg": function () { return $('#IDKegiatanSelected').val() }
                    }
                },
                "columnDefs":
                [
                {
                    "targets": [0,1,2,3,4],
                    "searchable": true,
                    "orderable": true
                },
                {
                    "targets": [5,6,7],
                    "visible": false,
                    "searchable": false
                }
                ],
                "columns": [
                    { "data": "NUPRGRM90", "name": "NUPRGRM90", "autoWidth": true },
                    { "data": "NMPRGRM90", "name": "NMPRGRM90", "autoWidth": true },
                    { "data": "NUKEG90", "name": "NUKEG90", "autoWidth": true },
                    { "data": "NMKEG90", "name": "NMKEG90", "autoWidth": true },
                    { "data": "NMTAHUN", "name": "NMTAHUN", "autoWidth": true },
                    { "data": "IDKEG", "name": "IDKEG", "autoWidth": true }, //hide
                    { "data": "IDKEG90", "name": "IDKEG90", "autoWidth": true }, //hide
                    { "data": "KDTAHUN", "name": "KDTAHUN", "autoWidth": true }, //hide
                    {
                        "render": function (data, type, full, meta)
                        {
                            return '<a class="btn btn-md btn-success icon-edit" data-toggle="tooltip" data-placement="top" title="Ubah Mapping" href="@Url.Action("MappingKegiatan13_90Edit", "Mapping")' + "?idKeg=" + full.IDKEG + "&idKeg90=" + full.IDKEG90 + "&kdTahun=" + full.KDTAHUN + '"></a>&nbsp;' +
                                '<a class="OpenModal btn btn-md btn-danger icon-trash" data-toggle="tooltip" data-placement="top" title="Hapus Mapping" data-kegiatan="' + full.NMKEG90 + '" href="#confirm-delete"></a>';
                        }
                    },
                ]

            });

        });

        </script>

</head>
<body>
    @using (Html.BeginForm(null, null, FormMethod.Post, new { @class = "form-horizontal", @name = "frmMappingKegiatan13_90", @ng_app = "Mapping13_90App", @data_ng_controller = "validateCtrl" }))
    {
        <div class="span12">
            @if (!Html.ViewData.ModelState.IsValid)
            {
                <div class="alert alert-danger">
                    @Html.ValidationSummary()
                </div>
            }

            @if (ViewBag.Info != "" && ViewBag.Info != null)
            {
                <div class="alert alert-success">@ViewBag.Info</div>
            }
            <div class="alert-delete"></div>
            <div class="widget">
                <div class="widget-header">
                    <i class="icon-list-alt"></i>
                    <h3>Mapping - Kegiatan 13 (lama) ke Permen 90</h3>
                </div>
                <div class="widget-content">
                    <fieldset>
                        <div class="form-group">
                            <label class="control-label" for="program">Program</label>
                            <div class="controls-filter">
                                <input type="text"   id="program" name="program" ng-invalid ng-model="program" class="form-control input-sm flexdatalistprogram span6" placeholder='Isi Nama Program' required>
                                @Html.Hidden("IDProgramSelected")
                                @Html.Hidden("NameProgramSelected")
                                <span style="color:maroon" ng-show="frmMappingKegiatan13_90.program.$dirty && frmMappingKegiatan13_90.program.$invalid">
                                    <span ng-show="frmMappingKegiatan13_90.program.$error.required">Program harus diisi</span>
                                </span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label" for="kegiatan">Kegiatan</label>
                            <div class="controls-filter">
                                <input type="text" id="kegiatan" name="kegiatan" ng-invalid ng-model="kegiatan" class="form-control input-sm flexdatalistkegiatan span6" placeholder='Isi Nama Kegiatan' required>
                                @Html.Hidden("IDKegiatanSelected")
                                @Html.Hidden("NameKegiatanSelected")
                                <span style="color:maroon" ng-show="frmMappingKegiatan13_90.kegiatan.$dirty && frmMappingKegiatan13_90.kegiatan.$invalid">
                                    <span ng-show="frmMappingKegiatan13_90.kegiatan.$error.required">Kegiatan harus diisi</span>
                                </span>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="controls-filter">
                                @*<input type="button" value="Cari" id="btnCari" />*@
                                <button type="button" class="btn btn-primary" id="btnCari" ng-disabled="frmMappingKegiatan13_90.$invalid"><i class="btn-icon-only icon-search"> Cari </i></button>
                            </div>
                        </div>
                    </fieldset>
                </div>
            </div>
        </div>

        <div class="span12">
            <div class="widget">
                <div class="widget-content">
                    <table id="list" class="table table-striped table-bordered dt-responsive nowrap header-cursor" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Nomor Program</th>
                                <th>Nama Program</th>
                                <th>Nomor Kegiatan</th>
                                <th>Nama Kegiatan</th>
                                <th>Tahun</th>
                                <th>ID Kegiatan</th>
                                <th>ID Kegiatan 90</th>
                                <th>KD Tahun</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                    </table>
                    <br>
                    <button type="button" style="display:block;" class="btn btn-success" id="btnTambah"><i class="btn-icon-only icon-plus"> Tambah </i></button>
                    <br>
                </div>
            </div>
        </div>


        <div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">

                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="myModalLabel">Konfirmasi Hapus</h4>
                    </div>

                    <div class="modal-body">
                        <p>Apakah anda yakin menghapus data mapping <b><i class="mapping"></i></b> ?</p>
                        <p class="debug-url"></p>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Batal</button>
                        <a class="btn btn-danger btn-ok">Hapus</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="ModalExistData" role="dialog">
            <div class="modal-dialog modal-sm">
                <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Informasi</h4>
                </div>
                <div class="modal-body">
                    <p>Data mapping sudah ada.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
                </div>
            </div>
        </div>
        
        
    }
</body>
</html>

<script>

    jQuery(document).ready(function () {
        //document.getElementById("btnCari").disabled = true;

        jQuery("#btnTambah").click(function () {
            //var _idPrgrm = $('#IDProgramSelected').val();
            //alert(_idPrgrm);
            var _idKeg = $('#IDKegiatanSelected').val();
            if (_idKeg == "") {
                return;
            }

            //var table = $('#listdetail').DataTable();
            //if (table.data().count() > 0) {
            //    $('#ModalExistData').modal('show');
            //}
            //else {
            window.location.href = '@Url.Action("MappingKegiatan13_90Create", "Mapping")' + "?idKeg=" + _idKeg;
            //}

        });

        var table = $("#list").DataTable();
        $('#list tbody').on('click', 'tr', function () {
            var sData = table.row(this).data()
            idKeg = sData["IDKEG"];
            idKEG90 = sData["IDKEG90"];

        });
    });

    $('.flexdatalistprogram').flexdatalist({
        cache: false,
        searchContain: true,
        textProperty: '{NUPRGRM}' + ' ' + '{NMPRGRM}',
        valueProperty: 'iso2',
        minLength: 0,
        focusFirstResult: true,
        selectionRequired: true,
        noResultsText: 'Tidak ada hasil untuk "{keyword}"',
        visibleProperties: ["NUPRGRM", "NMPRGRM"],
        searchIn: ["NUPRGRM", "NMPRGRM"],
        url: '@Url.Content("~/")' + 'Mapping/GetMPGRM/',
        //params: paramsKey,
        relatives: '#relative'
    }).on("select:flexdatalist", function (event, data) {
        $('#IDProgramSelected').val(data.IDPRGRM);
        $('#NameProgramSelected').val(data.NMPRGRM);

        $('#kegiatan').val('').parent().find("ul.flexdatalist-multiple li.value").remove();
    });

    var paramsKeyKeg = { idPgrm:"" };
    $('.flexdatalistkegiatan').on('before:flexdatalist.data', function (event) {
        var prg = $('#IDProgramSelected').val();
        paramsKeyKeg = { idPgrm: prg }
        $('.flexdatalistkegiatan').flexdatalist('params', paramsKeyKeg);
    });

    $('.flexdatalistkegiatan').flexdatalist({
        cache: false,
        searchContain: true,
        textProperty: '{NUKEG}' + ' ' + '{NMKEG}',
        valueProperty: 'iso2',
        minLength: 0,
        focusFirstResult: true,
        selectionRequired: true,
        noResultsText: 'Tidak ada hasil untuk "{keyword}"',
        visibleProperties: ["NUKEG", "NMKEG"],
        searchIn: ["NUKEG", "NMKEG"],
        url: '@Url.Content("~/")' + 'Mapping/GetMKEGIATAN/',
        params: paramsKeyKeg,
        relatives: '#relative'
    }).on("select:flexdatalist", function (event, data) {
        $('#IDKegiatanSelected').val(data.IDKEG);
        $('#NameKegiatanSelected').val(data.NMKEG);
    });

    $("#btnCari").click(function () {
        //idKeg = "";
        var table = $("#list").DataTable();
        table.ajax.reload();

        //document.getElementById("btnTambah").style.display = "block";
    });


    var app = angular.module('Mapping13_90App', []);
    app.controller('validateCtrl', function ($scope) {
        $scope.program = '@ViewBag.programName';
        $scope.kegiatan = '@ViewBag.kegiatanName';
    });

    //delete function
    $(document).on("click", ".btn-ok", function (e) {
        if (deleteStatus == true) //only 1 working in 1 click ok function
        {
            var url = '@Url.Content("~/")' + "Mapping/DeleteMappingKegiatan13_90";
            $.post(url, { idKeg: idKeg, idKEG90: idKEG90 }, function (data) {
                if (data == "Deleted") {
                    oTable = $('#list').DataTable();
                    oTable.draw();
                    // add alert after delete
                    addAlert();
                }
                else {
                    alert("Terjadi kesalahan! Error" + data);
                }
            });
            deleteStatus = false;
            $('#confirm-delete').modal('hide');//if success then hide
        }

    })

    $(document).on("click", ".OpenModal", function (e) {
        e.preventDefault();
        deleteStatus = true;
        var _self = $(this);
        var _namKeg = _self.data('NameKegiatanSelected');
        $(".namKeg").text(_namKeg);

        $(_self.attr('href')).modal('show');
    });

    function addAlert() {
        var _namKeg = $(".namKeg").text();
        var div = document.createElement('div');
        div.className = 'alert alert-success';
        div.innerHTML =
            '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>\
                 Mapping kegiatan <b>' + _namKeg + '</b> berhasil dihapus.';

        document.getElementsByClassName("alert-delete")[0].appendChild(div);
    }


</script>